pipeline {
    agent any
    
    environment {
        // Grafana Cloud è¨­å®š (è«‹æ›¿æ›ç‚ºæ‚¨çš„å¯¦éš›å€¼)
        GRAFANA_URL = 'https://your-instance.grafana.net'
        GRAFANA_API_KEY = credentials('grafana-api-key')
    }
    
    stages {
        stage('ğŸš€ é–‹å§‹éƒ¨ç½²') {
            steps {
                echo 'ğŸ” é–‹å§‹è‡ªå‹•éƒ¨ç½²æµç¨‹...'
                echo "ğŸ“Š ç›®æ¨™: xsong.us ç¶²ç«™ç›£æ§ Dashboard"
                echo "ğŸŒ Grafana URL: ${GRAFANA_URL}"
            }
        }
        
        stage('ğŸ“¥ æ‹‰å–ç¨‹å¼ç¢¼') {
            steps {
                echo 'ğŸ” æ­£åœ¨æ‹‰å–æœ€æ–°ç¨‹å¼ç¢¼...'
                checkout scm
                
                sh '''
                    echo "=== Git è³‡è¨Š ==="
                    echo "åˆ†æ”¯: $(git branch --show-current)"
                    echo "æäº¤: $(git log -1 --pretty=format:"%h - %s")"
                '''
                
                echo 'âœ… ç¨‹å¼ç¢¼æ‹‰å–å®Œæˆ'
            }
        }
        
        stage('ğŸ“Š ä¸Šå‚³ Dashboard') {
            steps {
                echo 'ğŸ“Š ä¸Šå‚³ Dashboard åˆ° Grafana Cloud...'
                script {
                    // è®€å– dashboard.json
                    def dashboardContent = readFile('dashboard.json')
                    
                    // ä¸Šå‚³åˆ° Grafana
                    sh """
                        curl -X POST \\
                            -H "Authorization: Bearer ${GRAFANA_API_KEY}" \\
                            -H "Content-Type: application/json" \\
                            -d '${dashboardContent}' \\
                            ${GRAFANA_URL}/api/dashboards/db \\
                            -w "\\nHTTP_STATUS:%{http_code}\\n"
                    """
                }
                echo 'âœ… Dashboard ä¸Šå‚³å®Œæˆ'
            }
        }
        
        stage('ğŸ” é©—è­‰éƒ¨ç½²') {
            steps {
                echo 'ğŸ” é©—è­‰éƒ¨ç½²çµæœ...'
                script {
                    def searchResult = sh(
                        script: """
                            curl -s -H "Authorization: Bearer ${GRAFANA_API_KEY}" \\
                                "${GRAFANA_URL}/api/search?query=xsong.us" \\
                                -w "\\nHTTP_STATUS:%{http_code}\\n"
                        """,
                        returnStdout: true
                    )
                    
                    echo "ğŸ” æœå°‹çµæœ: ${searchResult}"
                    
                    if (searchResult.contains('xsong.us')) {
                        echo 'âœ… Dashboard é©—è­‰æˆåŠŸï¼'
                    } else {
                        echo 'âš ï¸ Dashboard é©—è­‰å¤±æ•—ï¼Œè«‹æ‰‹å‹•æª¢æŸ¥'
                    }
                }
            }
        }
    }
    
    post {
        success {
            echo 'ğŸ‰ éƒ¨ç½²æˆåŠŸï¼'
            echo "ğŸ“Š è«‹å‰å¾€ ${GRAFANA_URL} æŸ¥çœ‹æ‚¨çš„ Dashboard"
            echo "ğŸ“§ å‘Šè­¦å°‡ç™¼é€åˆ°: me@xsong.us"
        }
        
        failure {
            echo 'âŒ éƒ¨ç½²å¤±æ•—ï¼'
            echo 'ğŸ” è«‹æª¢æŸ¥ Grafana Cloud è¨­å®š'
        }
        
        always {
            echo 'ğŸ§¹ æ¸…ç†å®Œæˆ'
        }
    }
}
